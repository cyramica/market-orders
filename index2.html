<!DOCTYPE html>
<html>
<body>

  <p>Key: <input name="Key" type="text" maxlength="255" id="keyID" class="inputText" /></p>
  <p>Verification: <input name="verification" type="text" maxlength="255" id="vCode" class="inputText" /></p>
  <input type="button" value="Go" onclick="startaSkiten(keyID.value, vCode.value);">
  <div id="mainContent"></div>

  <script>

    if (localStorage.getItem('keyID') != null) { 
        document.getElementById('keyID').value = localStorage.getItem('keyID');
        document.getElementById('vCode').value = localStorage.getItem('vCode');
    }

    function startaSkiten(keyID, vCode) {
        console.log(keyID + vCode);
      
        var xhr = new XMLHttpRequest();
        if ('withCredentials' in xhr) {

            xhr.open("GET", "https://api.eveonline.com/char/MarketOrders.xml.aspx?keyID=" + keyID + "&vCode=" + vCode, true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 400) {
                        // JSON.parse (req.responseText) etc.
                        var xmlDocument = xhr.responseXML;
                        var data = xmlDocument.getElementsByTagName("row");

                        document.getElementById('mainContent').innerHTML = "";

                        for (i = 0; i < data.length; i++) {

                // orderState:  0 = open/active 1 = closed, 2 = expired, 3 = cancelled, 4 = pending, 5 = character deleted
                
                            if (data[i].getAttribute('orderState') == "2") {
                
                                stationID = data[i].getAttribute('stationID');
                                typeID = data[i].getAttribute('typeID')
                                item = getItemName(data[i].getAttribute('typeID'));
                                document.getElementById('mainContent').innerHTML += "stationID: " + stationID + "<br>";
                                document.getElementById('mainContent').innerHTML += "Item: " + i + " " + item + "<br><br>";
                                maxPrice = eveMarketData(typeID, stationID);

                }
            }   

        }
                    } else {
                        // Handle error case
                    }
            };
        }
            //xhr.setRequestHeader('Content-Type', 'text/xml');
        xhr.send();


        localStorage.setItem('keyID', keyID);
        localStorage.setItem('vCode', vCode);
        
    }

    function eveMarketData(typeID, stationID) {
        var xhrEMD = new XMLHttpRequest();
        if ('withCredentials' in xhrEMD) {
            xhrEMD.open("GET", "http://api.eve-central.com/api/marketstat/json?typeid=" + typeID + "&stationid=" + stationID, true);

            xhrEMD.onreadystatechange = function() {
                if (xhrEMD.readyState == 4) {
                    document.write(xhrEMD.reponseXML + "<br>");
                    var emdJson = JSON.parse(xhrEMD.responseXML);
                    document.write(emdJson);
                    return(emdJson);
                }
            }
        }        
        xhrEMD.send();


    }

    function getItemName(name) {
        var xhrItemName = new XMLHttpRequest();
        xhrItemName.open("GET", "https://api.eveonline.com/eve/TypeName.xml.aspx?ids=" + name , false);
        xhrItemName.send();
        xmlItemName = xhrItemName.responseXML;
        var itemData = xmlItemName.getElementsByTagName("row");
        return itemData[0].getAttribute('typeName');
    }


  </script>


</body>
</html>